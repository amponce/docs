---
title: "Turn Detection"
sidebarTitle: "Turn Detection"
description: "Configure how your agent detects when the user has finished speaking, including greedy speculative inference."
---

Turn detection determines when your agent should start responding. Getting this right is critical for natural conversation flow -- respond too early and you interrupt the user, respond too late and there is awkward silence.

Relay Agent supports two turn detection modes: **fixed** and **greedy**.

## Fixed Mode

In fixed mode, the agent waits for a confirmed silence gap (utterance end) before starting LLM inference. This is the simplest approach and produces the most reliable results, but adds latency equal to the silence detection window.

```
User speaks → Silence detected → LLM starts → TTS starts → User hears response
                 ↑
            endpointingMs wait
```

## Greedy Mode (Recommended)

In greedy mode, the agent starts LLM inference speculatively on the first `speech_final` signal, before the user has confirmed they are done speaking. If the user continues talking, the in-flight LLM request is cancelled and a new one is started with the updated transcript.

```
User speaks → speech_final → LLM starts (speculative)
                                    ↓
              User continues? → Cancel LLM, restart with new text
              User done?     → Commit, continue to TTS
```

This can reduce perceived latency by 200-500ms because the LLM starts generating before the silence gap is fully confirmed.

### State Machine

The greedy inference manager operates as a three-state machine:

```
idle ─── onSpeechFinal ──► speculating
                             │      ▲
              onSpeechFinal ─┘      │  (cancel + restart, up to maxRestarts)
                             │
              onUtteranceEnd ─┤
              onFirstAudio  ──┤
                             ▼
                          committed ─── onTurnComplete ──► idle
```

- **idle**: Waiting for the user to speak.
- **speculating**: An LLM request is in flight, but may be cancelled if the user keeps talking.
- **committed**: The response is locked in. Either the utterance end was confirmed, or the first audio chunk was sent to the caller.

## Configuration

Turn detection is configured in `settings.turnDetection`:

```json
{
  "settings": {
    "turnDetection": {
      "mode": "greedy",
      "endpointingMs": 300,
      "utteranceEndMs": 1000,
      "greedyCommitOnFirstAudio": true,
      "maxRestarts": 3
    }
  }
}
```

| Field | Type | Default | Description |
|-------|------|---------|-------------|
| `mode` | `string` | `"greedy"` | Turn detection mode: `"fixed"` or `"greedy"`. |
| `endpointingMs` | `number` | `300` | Milliseconds of silence before a speech segment is finalized. Range: 100-2000. |
| `utteranceEndMs` | `number` | `1000` | Milliseconds of silence before the utterance is considered complete. Range: 200-5000. |
| `greedyCommitOnFirstAudio` | `boolean` | `true` | In greedy mode, commit the response when the first TTS audio chunk is sent. |
| `maxRestarts` | `number` | `3` | Maximum cancel/restart cycles per turn in greedy mode. Range: 0-10. |

## Settings Explained

### endpointingMs

Controls how quickly a speech segment is finalized. Lower values make the agent more responsive but increase the risk of cutting off the user mid-sentence.

| Value | Behavior |
|-------|----------|
| `100-200` | Very responsive. Good for short answers (yes/no, numbers). May cut off longer sentences. |
| `300` (default) | Balanced. Works well for most conversations. |
| `500-1000` | Conservative. Waits longer before responding. Better for users who pause mid-thought. |
| `1000-2000` | Very patient. Use for elderly callers or when the user is providing complex information. |

### utteranceEndMs

Controls how long after the last speech to wait before confirming the utterance is complete. In greedy mode, this is the point where a speculative response is committed.

| Value | Behavior |
|-------|----------|
| `200-500` | Aggressive. Faster responses but may commit before the user finishes a multi-part thought. |
| `1000` (default) | Balanced for most conversations. |
| `2000-5000` | Very patient. Use when users frequently pause for 1-3 seconds mid-thought. |

### greedyCommitOnFirstAudio

When `true` (default), the speculative response is committed as soon as the first audio chunk is sent to the caller. At that point, the user has already started hearing the response, so cancelling would be jarring.

When `false`, the response can still be cancelled even after audio starts playing. This is useful in scenarios where you want maximum accuracy and are willing to occasionally restart mid-response.

### maxRestarts

Limits how many times the greedy manager can cancel and restart the LLM per turn. This prevents infinite cancel loops when the user is dictating a long sentence with many interim speech finals.

| Value | Behavior |
|-------|----------|
| `0` | No restarts. First speculative response is always committed. Equivalent to fixed mode with early start. |
| `3` (default) | Up to 3 cancel/restart cycles. Good balance. |
| `5-10` | More restarts allowed. Better accuracy for users who speak in bursts. |

When `maxRestarts` is exceeded, the current speculative response is auto-committed rather than restarted again.

## Latency Comparison

| Mode | Typical Added Latency | Quality |
|------|----------------------|---------|
| Fixed (`endpointingMs: 300`) | +300-500ms | Most reliable |
| Fixed (`endpointingMs: 500`) | +500-800ms | Very reliable |
| Greedy (default settings) | +0-200ms | Good, occasional restart |
| Greedy (`maxRestarts: 0`) | +0-100ms | Fastest, may respond to partial input |

<Tip>
  Start with greedy mode and default settings. Only switch to fixed mode if you notice the agent responding to incomplete sentences. Greedy mode provides a noticeably faster conversational experience.
</Tip>

## When to Use Each Mode

### Use Greedy Mode When

- Response speed is a priority.
- The conversation involves short exchanges (Q&A, confirmations).
- Users speak in complete, relatively short sentences.
- You are using a fast LLM (gpt-4o-mini, Groq).

### Use Fixed Mode When

- Accuracy is more important than speed.
- Users speak in long, complex sentences with natural pauses.
- The agent handles critical tasks where responding to partial input could cause problems.
- You are using a slower LLM where cancelled requests waste significant compute.

## Interaction with Other Settings

Turn detection works alongside other agent settings:

- **`responsiveness`** (0-1): Affects overall response timing. Higher values make the agent jump in faster.
- **`interruptionSensitivity`** (0-1): Controls when the agent stops speaking if the user interrupts. Independent of turn detection.
- **`backchanneling`**: Filler words like "mm-hmm" can be emitted during the user's turn, independent of turn detection mode.

```json
{
  "settings": {
    "responsiveness": 0.8,
    "interruptionSensitivity": 0.7,
    "backchanneling": true,
    "turnDetection": {
      "mode": "greedy",
      "endpointingMs": 300,
      "utteranceEndMs": 1000,
      "greedyCommitOnFirstAudio": true,
      "maxRestarts": 3
    }
  }
}
```

<Warning>
  Lowering `endpointingMs` below 200 in greedy mode can cause the agent to fire speculative requests on almost every word, significantly increasing LLM costs due to cancelled requests. Monitor your usage if you use aggressive settings.
</Warning>
